<!--{add_css file="/themes/merchants/css/order.css" scope="module"}-->
<!--{add_css file="/themes/merchants/css/bootstrap-datetimepicker.min.css" scope="module"}-->
<!--{add_css file="/themes/merchants/css/kkpager_orange.css" scope="module"}-->
<!--{add_js file="/themes/merchants/js/kkpager.min.js" scope="module" pos="foot"}-->
<!--{add_js file="/misc/js/ext/bootstrap/bootstrap-datetimepicker.min.js" scope="module" pos="foot"}-->
<!--[HEAD_CSS]-->
<style>
.table-condensed>tbody>tr>td, .table-condensed>tbody>tr>th,
.table-condensed>thead>tr>td, .table-condensed>thead>tr>th{
	padding:0px !important;
}
</style>
<!--[/HEAD_CSS]-->
<!--{include file="inc/left_common.htm"}-->
<div id="order_list_right">
	<div id="order_type">
		<ul>	
			<li class="order_type_on">所有订单</li>
			<li data-type='100'>待付款</li>
			<li data-type='105'>备货中</li>
			<li data-type='101'>待发货</li>
			<li data-type='103'>待收货</li>
			<li data-type='102'>交易完成</li>
			<li data-type='104'>交易关闭</li>
		</ul>
	</div>
	
	<div id="choose_condition">
		<input type="input" id="start_date" readonly class="form_datetime check_time_left" placeholder="请选择开始日期"/>
		<!-- <div class="check_time_left" id="time_left">
		</div> --> 
		<span style="padding-left:15px;">至</span>
		<input type="input" id="end_date" readonly class="form_datetime check_time_left" placeholder="请选择结束日期"/>
		<input class="check_time_left" contenteditable id="order_num" placeholder="订单号">
		<input class="check_time_left" contenteditable id="buyer"  placeholder="买家">
		<button id="search_type_infos">搜索</button>
	</div>
	
	<div id="type_infos">
		<table cellspacing="0" cellpadding="0" id="type_table_list">
			<tr>
				<th>选择</th>
				<th>订单号</th>
				<th>买家</th>
				<th>下单时间</th>
				<th>订单总额</th>
				<th>订单状态</th>
				<th>支付方式</th>
				<th width="100px;">操作</th>
			</tr>
			<tbody class="body-data"></tbody>
		</table>
	</div>
		
	<div id="list_type_foot">
		<span id="all_check"></span>
		<button id="batch_send" onclick="deliveryOrderGoods(null, 'ship');">批量发货</button>
		<div id="kkpager" style="float:right;clear:none;padding:0px;"></div>
	</div>
</div>
<script>
var tableOptions = {id : 'type_table_list',url : '/order/list',colspan : 8};
$(function(){
	loadPageDataTable(1, true, tableOptions);
	$(".form_datetime").datetimepicker({format: 'yyyy-mm-dd',autoclose: true,todayBtn: true,minView:2});
	$("#order_type").on('click','li',function(){
		var obj = $(this);
		/* if(obj.hasClass("order_type_on")){
			return;
		} */
		clearQueryCondtion();
		obj.siblings().removeClass("order_type_on");
		obj.addClass("order_type_on");
		loadPageDataTable(1, true, tableOptions);
		var type = obj.data('type');
		if(type == 100 || type == 102 || type == 104){
			canBatchShip(false);
		}else{
			canBatchShip(true);
		}
	});
	$("#search_type_infos").on('click',function(){
		loadPageDataTable(1, true, tableOptions);
	});
	$("#type_table_list").on('click', '.order_look_up', function(){
		showOrderDetail(this);
	});
	$("#type_table_list").on('click', '.shipping', function(){
		deliveryOrderGoods(this, 'ship');
	});
	/* $("#type_table_list").on('click', '.shippingedit', function(){
		deliveryOrderGoods(this, 'edit');
	}); */
	$(".form_datetime").datetimepicker({format: 'yyyy-mm-dd',autoclose: true,todayBtn: true,
		minView:2,language:'zh-CN',clearBtn:true});
	
	$("#order_num").enterEvent(function(){
		loadPageDataTable(1, true, tableOptions);
	});
	$("#buyer").enterEvent(function(){
		loadPageDataTable(1, true, tableOptions);
	});
});

//清空当前页面条件
function clearQueryCondtion(){
	$("#order_num").val("");
	$("#buyer").val("");
	$("#start_date").val("");
	$("#end_date").val("");
}

//获取当前页面条件
function pageQueryCondtion(){
	var status = 0;
	$("#order_type").find("li").each(function(){
		var THIS = $(this);
		if(THIS.hasClass("order_type_on")){
			status = THIS.attr("data-type");
		}
	});
	var order_num = $("#order_num").val();
	var buyer = $("#buyer").val();
	var start_date = $("#start_date").val();
	var end_date = $("#end_date").val();
	
	var data = {order_sn : order_num,buyer : buyer, status : status, start_date : start_date, end_date : end_date};
	return data;
}
function costructRowData(result){
	var cls="common_check";
	var ship_st = result.shipping_status;
	var shipping = "";
	if(canOrderShip(result) && (ship_st == 0 || ship_st == 3 || ship_st == 5)){//未发货
		//cls = "common_check";
		shipping = "<span class=\"order_send_goods shipping\">发货</span>";
	}else{
		//cls = "common_check_disabled";
		/* if(ship_st != 2 && canOrderShip(result)){//已收货不能修改 已取消 不显示
			shipping = "<span class=\"order_send_goods shippingedit\">修改</span>";
		} */
	}
	var TR = "<tr data-id="+result.order_id+"><td class=\""+cls+"\"></td>";
	TR += "<td>"+result.order_sn+"</td>";
	TR += "<td>"+result.nick_name+"</td>";
	TR += "<td>"+result.add_time+"</td>";
	TR += "<td>￥"+result.actual_order_amount+"</td>";
	TR += "<td>"+result.order_status_text+"</td>";
	TR += "<td>"+result.pay_name+"</td>";
	TR += "<td class=\"attr_rel undocheck\"><span class=\"order_look_up\">查看</span>"+shipping+"</td></tr>";
	return TR;
}

function canOrderShip(result){
	return (result.pay_status == 2 && result.order_status != 2 && result.order_status != 3);
}

function showOrderDetail(obj){
	var order_id = $(obj).closest("tr").first().data("id");
	if(order_id){
		window.location.href="/order/detail?order_id="+order_id;
	}
}

function deliveryOrderGoods(obj, act){
	var order_ids = "";
	if(obj){
		order_ids = [$(obj).closest("tr").first().data("id")];
	}else{
		order_ids = getSelectIds();
	}
	if(!order_ids || !order_ids.length){
		showMsg('请选择要发货的订单！');
		return;
	}
	order_ids = order_ids.join(",");
	window.location.href = '/order/shipping/form?act='+act+'&order_ids='+order_ids;
}

function canBatchShip(flag){
	if(flag){
		$("#all_check").show();
		$("#batch_send").show();
	}else{
		$("#all_check").hide();
		$("#batch_send").hide();
	}
}

</script>