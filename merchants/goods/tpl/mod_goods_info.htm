<!--{add_css file="/themes/merchants/css/goods.css" scope="module"}-->
<!--{add_js file="/misc/editor/ueditor_full/ueditor.config.js" scope="module"}-->
<!--{add_js file="/misc/editor/ueditor_full/ueditor.all.min.js" scope="module"}-->
<style>
.stand1,.stand2{
	display:none;
}
</style>
<div id="body" class="ifr-body">
	<!--{include file="inc/left_common.htm"}-->
	<form id="defaultForm" method="post" action="" onsubmit="return goods_submit();">
	<div class="goods_right">
		<div class="goods_nums">
			<ul>
				<li id="li1"  class="li_on">发布商品</li>
			</ul>
		</div>
		<div>
			<div class="iss_infos font_common">商品信息</div>
			<div class="infos_go">
				<div class="goods_type font_common">
					<label class="control-label"><span class="fill_red">*</span>商品名称：</label>
				</div>
				<div class="type_right font_common">
					<input type="text" value="<!--{$goodsinfo->item_name}-->" class="write_common" name="goods_name" required >
				</div>
			</div>
			
			<div class="infos_go">
				<div class="goods_type font_common">
					<label class="control-label"><span class="fill_red">*</span>市场价：</label>
				</div>
				<div class="type_right font_common">
					<input type="text" value="<!--{$goodsinfo->market_price}-->" class="write_short" name="market_price" data-type='money' required > 元
					
					<label class="control-short" style="padding-left:47px;">成本价：</label>
					<input type="text" value="<!--{$goodsinfo->cost_price}-->" class="write_short" name="cost_price" data-type='money'> 元<span class="prompt_common">净毛利统计时会使用到，买家不可见</span>
				</div>
			</div>
			
			<div class="infos_go">
				<div class="goods_type font_common">
					<label class="control-label"><span class="fill_red">*</span>售价：</label>
				</div>
				<div class="type_right font_common">
					<input type="text" value="<!--{$goodsinfo->shop_price}-->" class="write_short" name="shop_price" data-type='money' required > 元
					
					<label class="control-short"><span class="fill_red">*</span>供货价：</label>
					<input type="text" value="<!--{$goodsinfo->income_price}-->" class="write_short" name="income_price" data-type='money' required > 元<span class="prompt_common">佣金<i>0.00</i>元 给到平台的价格，用来计算佣金 ，买家不可见</span>
				</div>
			</div>
			
			<div class="infos_go">
				<div class="goods_type font_common">
					<label class="control-label"><span class="fill_red">*</span>库存：</label>
				</div>
				<div class="type_right font_common">
					<input type="number" value="<!--{$goodsinfo->item_number}-->" class="write_short" name="goods_number" required >
					
					<label class="control-short" style="padding-left:35px;"><span class="fill_red"></span>每人限购：</label>
					<input type="number" value="<!--{$goodsinfo->per_limit_buy}-->" class="write_short" name="per_limit_buy" ><span class="prompt_common">0代表不限购</span>
				</div>
			</div>
			
			<div class="infos_go">
				<div class="goods_type font_common">
					<label class="control-label"><span class="fill_red">*</span>商品分类：</label>
				</div>
				<div class="type_right font_common">
					<select class="check_s c_goods_type" name="cat_id" id="cat_id" onchange="hideCatDiv()" required >
						<option value="">请选择...</option>
  						<!--{$cat_list}-->
					</select>
					<button type="button" class="add_common add_type">添加分类</button> 
					<label class="add_type_hide">
						<input type="text" val="" class="add_input category_val"><button type="button" class="add_common add_category">确定</button>
						<button class="add_common cancel_s hide_category"> << </button>
					</label>
				</div>
			</div>
			
			<div class="infos_go">
				<div class="goods_type font_common">
					<label class="control-label">扩展分类：</label>
				</div>
				<div class="type_right font_common">
				  <button type="button" class="add_common add_other_type">新增分类</button>
				  <!--{if isset($goodsinfo) }-->
				  <!--{foreach from=$goodsinfo->other_cat item=cat_id}-->
	              <select name="other_cat"><option value="">请选择</option><!--{$other_cat_list.$cat_id}--></select>
	              <!--{/foreach}-->
	              <!--{/if}-->
				</div>
			</div>
			
			<div class="infos_go">
				<div class="goods_type font_common">
					<label class="control-label"><span class="fill_red">*</span>商品图片：</label>
				</div>
				<div class="type_right font_common">
					<!--{if isset($gallery) }-->
				  	<!--{foreach from=$gallery item=g}-->
					<div class="add_img goods_gallery">
					<img src="<!--{$g->thumb_url}-->" data-ori="<!--{$g->img_original}-->" data-std="<!--{$g->img_url}-->" onclick="galleryPicSelect(this)" class="<!--{if $g->thumb_url == $goodsinfo->item_thumb }-->add_img_selected<!--{/if}-->">	'
					</div>
					<!--{/foreach}-->
	              	<!--{/if}-->
					<div class="add_img publish_img">	
						<img src="/themes/merchants/img/editor_plus.png">			
						<input type="file" id="file" name="file" class="dj_fil" onchange="fileupload(event, this)">	
					</div>
				</div>
			</div>
		</div>
		<div class="clear"></div>
		
		<div>
			<div class="iss_infos font_common">规格/库存</div>
			<div class="infos_go">
				<div class="goods_type font_common">
					<label class="control-label">商品规格：</label>
				</div>
				
				<div class="type_right font_common" style="float:left;">
					<div class="stand1">		
						<div class="stand_check_top">
							<div class="stand_check"></div>
						 	<div class="z_in_height">
								<div class="check_list_info">
									<ul>
							 			<li data-cat='1'>酒1</li>
										<li data-cat='2'>酒2</li>
										<li data-cat='3'>酒3</li>
							 		</ul>
								</div>
							</div>
						</div>
						
						<div style="height:40px;" class="add_del_y"><span class="add_common_a">+添加</span></div>
						<div class="common_a_tow">
				 			<div class="result_d">
				 				<div  class="common_a_li" style="display:none;">
			 						<ul>
										<li data-attr="1">黄</li>
									 	<li data-attr="2">红</li>
									 	<li data-attr="3">蓝</li>
									 </ul>
								</div>
			 				</div>
			 				<button type="button" class="add_common ok_one">确定</button><button type="button" class="add_common cancel_one">取消</button>
						</div>
					</div>
					
					<div class="add_stand">
						<button type="button" class="add_common add_s_projcet">添加规格项目</button>
					</div>
				</div>
			</div>
			<div class="clear"></div>
			
			<div class="infos_go goods_stockDIV" style="display:none;">
				<div class="goods_type font_common">
					<label class="control-label"><span class="fill_red">*</span>商品库存：</label>
				</div>
				<div class="type_right font_common" style="margin-top:20px;">
					<table cellspacing="0" cellpadding="0" class="goods_stocks">
						
					</table>
				</div>
			</div>
			
			<div>
				<div class="iss_infos font_common">物流信息</div>
					<div class="infos_go">
					<div class="goods_type font_common">
						<label class="control-label"><span class="fill_red">*</span>运费：</label>
					</div>
					<div class="type_right font_common" style="float:left;">
						<p class="freight fre_on">统一运费   <input type="text" value="<!--{$goodsinfo->shipping_fee}-->" name="shipping_fee" class="frei_money" data-type='money'> 元</p>
						<!-- <p class="freight">运费模板   
							<select class="check_s c_goods_type">
								<option value ="1">酒</option>
		  						<option value ="2">衣服</option>
		  						<option value ="3">食品饮料饮料</option>
		  						<option value ="4">饮料</option>
							</select>
							<span class="frei_color">新增运费模板</span>
						</p> -->
					</div>
					<div class="clear"></div>
					
					<div class="infos_go">
					<div class="goods_type font_common">
						<label class="control-label"><span class="fill_red">*</span>商品描述：</label>
					</div>
					<script id="editor" name="goods_desc" type="text/plain" style="width:90%;height:200px;"></script>
					<input type="submit" val="publish" id="submitBtn"/>
				</div>
			</div>
		</div>
	</div>
</div>
	<input type="hidden" value="<!--{$goodsinfo->item_id}-->" name="goods_id"/>
	</form>
<div class="mask"></div>

<script>
$(function(){
	initCategoryEvent();
	UE.getEditor('editor');
	//判断ueditor 编辑器是否创建成功
    UE.getEditor('editor').addListener("ready", function () {
	    // editor准备好之后才可以使用
	    UE.getEditor('editor').setContent("<!--{$goodsinfo->item_desc}-->");
    });
});
function goods_submit(){
	if(!$("#defaultForm").formValid()){
		return false;
	}
	var gallerys = $(".goods_gallery");
	if(!gallerys || !gallerys.length){
		alert('请上传商品图片！');
		return false;
	}
	var data = $("#defaultForm").serializeJson();
	data.gallery_list = [];
	gallerys.each(function(){
		var obj = $(this);
		var imgobj = obj.find("img");
		if(!imgobj)return true;
		var gall = {gallery_img : imgobj.attr("data-std"), gallery_thumb : imgobj.attr("src"),origin_img : imgobj.attr("data-ori")};
		if(imgobj.hasClass("add_img_selected")){
			data.goods_thumb = gall.gallery_thumb;
			data.goods_img = gall.gallery_img;
			data.original_img = gall.origin_img;
		}
		data.gallery_list.push(gall);
	});
	if(!data.goods_img){
		alert('请点击商品图片选择预览图片');
		return false;
	}
	var goods_desc = UE.getEditor('editor').getContent();
	if(!goods_desc || !goods_desc.length){
		alert('还没有填写商品描述！');
		return false;
	}
	buildGoodsSpecif(data);
	console.log(data);
	$("#submitBtn").attr("disabled", "disabled");
	$.post('/goods/publish', data, function(ret){
		if(ret && ret.result == 'SUCC'){
			alert('商品发布成功！');
			window.location.href = '/goods';
		}else{
			alert('商品发布失败，请稍后重试！');
			$("#submitBtn").removeAttr("disabled");
		}
	});
	return false;
}

function hideCatDiv(){
	if($(".add_type_hide").is(":visible")){
		$(".add_type_hide").hide();
	}
}

function initCategoryEvent(){
	//显示添加分类
	$(".add_type").on("click",function(event){
		$(".add_type_hide").show();
		event.preventDefault();
	});
	$(".hide_category").on("click",function(event){
		$(".add_type_hide").hide();
		event.preventDefault();
	});
	//确定添加分类
	$(".add_category").on("click",function(e){
      	var cat = $(".category_val").val();
      	if(!cat || cat.replace(/^\s+|\s+$/g, '') == '')
      	{
          	alert('分类不能为空！');
          	return;
      	}
		var parent_id = $("#cat_id").val();
      	var params = {cat_id : parent_id, cat_name : cat};
      	F.postWithLoading('/goods/simply/category', params, function(ret){
      		if(!ret.status){
      			alert(ret.retmsg);
      			return;
      		}else{
	      		addCatResponse(ret.result, parent_id, cat);
	      		$(".category_val").val("");
	      		$(".add_type_hide").hide();
      		}
      	});
	});

	//添加一个分类
	$(".add_other_type").on("click",function(){
		var _select = $("#cat_id").clone();
		$(_select).removeAttr("id");
		$(_select).removeAttr("required");
		$(_select).attr("name","other_cat");
		$(this).parent().append(_select);
		event.preventDefault();
	});
}

function addCatResponse(cat_id, parent_id, cat_name){
    if(!cat_id){
    	return;
    }

    var selCat = document.forms['defaultForm'].elements['cat_id'];
    var opt = document.createElement("OPTION");
    opt.value = cat_id;
    opt.selected = true;
    opt.innerHTML = cat_name;

    var str = selCat.options[selCat.selectedIndex].text;
    var temp = str.replace(/^\s+/g, '');
    var lengOfSpace = str.length - temp.length;
    if(parent_id != 0)
    {
        lengOfSpace += 4;
    }
    for (i = 0; i < lengOfSpace; i++)
    {
        opt.innerHTML = '&nbsp;' + opt.innerHTML;
    }

    for (i = 0; i < selCat.length; i++)
    {
        if(selCat.options[i].value == parent_id)
        {
            if(i == selCat.length)
            {
            	selCat.appendChild(opt);
            }
            else
            {
                selCat.insertBefore(opt, selCat.options[i + 1]);
            }
            break;
        }
    }

    return;
}

function fileupload(e, obj){
	var url = '/goods/gallery';
	var galleryCount = $(".goods_gallery").length;
	var selectedCls = "";
	if(galleryCount < 1){
		selectedCls = "add_img_selected";
	}
	image_upload(url, e, obj, function(ret){
		var thumb = ret.thumb;
		var html =   '	<div class="add_img goods_gallery" onmouseover="galleryover(this)" onmouseout="galleryout(this)">'
			+'		<img src="'+thumb+'" class="'+selectedCls+'" data-ori="'+ret.result+'" data-std="'+ret.stdpath+'" onclick="galleryPicSelect(this)">	'
			+'      <img src="/themes/merchants/img/close_11.png" class="close_img_d" style="display:none;" onclick="deleteGallery(this)">'
			+'	</div>';
		$(".publish_img").before(html);
	});
}

function galleryPicSelect(obj){
	$(".add_img img").removeClass("add_img_selected");
	$(obj).addClass("add_img_selected");
}

function galleryover(obj){
	$(obj).find("img:last").show();
}

function galleryout(obj){
	$(obj).find("img:last").hide();
}

function deleteGallery(obj){
	$(obj).closest("div").first().remove();
	if($(".goods_gallery").length == 1){
		$(".goods_gallery").find("img:first").addClass("add_img_selected");
	}
}

$(function(){
	goodsSpecifiEvent();
	highlightSpecifi();
})
//商品规格事件监听
function goodsSpecifiEvent(){
	//添加规格
	$(".add_s_projcet").on("click",function(){
		var clone = $(".stand1").clone(true);
		clone.removeClass("stand1");
		clone.addClass("standFlag");
		if(!$(".standFlag").length){
			$(".stand1:last").after(clone);
		}else{
			$(".standFlag:last").after(clone);
		}
		if($(".standFlag").length == 3){
			$(".add_s_projcet").hide();
		}
	})
	//点击选择规格
	$(".stand_check").on("click",function(){
		var container = getContainer(this);
		var z_in_height = container.find('.z_in_height');
		
		if(!z_in_height.is(":visible")){
			z_in_height.show();   
		}else{
			z_in_height.hide();  
		}
		container.find(".common_a_li").hide();
		
		isSpecifSelected(container);
	})
	//点击规格项
	$('.check_list_info li').on("click",function(){
		var container = getContainer(this);
		var _text = $(this).text();
		var cat = $(this).data('cat')
		//var oldval = container.find(".stand_check").data('cat');
		var valid = true;
		/* //不能重新选择自己
		if(cat == oldval){
			return false;
		} */
		//不能跟其他规格相同
		if($(".stand_check[data-cat="+cat+"]").length){
			alert("规格不能相同");
			return false;
		}
		container.find(".stand_check").text(_text);
		container.find(".stand_check").attr('data-cat',cat);
		//重新选择规格，需要做一次重置
		container.find(".add_del_y .yjtj").remove();
		container.find(".common_a_li li").show();
		container.find(".z_in_height").hide();   
		isSpecifSelected(container);
		generateSpecifTable();
		
	})
	//点击添加属性
	$(".add_common_a").on("click",function(){
		var container = getContainer(this);
		container.find(".common_a_tow").show();
		container.find(".result_d .jt_g").remove();
		container.find(".common_a_li").show();
		showAttrList(container);
	});
	//点击属性项
	$(".common_a_li li").on("click",function(){
		var container = getContainer(this);
		var _child = $(this).text();
		$(this).hide();
		var attr = $(this).data('attr');
		container.find(".result_d").append('<span class="jt_g" data-attr='+attr+' onclick="jt_g_click(this)">'+_child+'</span>');
	});
	//点击确定属性
	$(".ok_one").on("click",function(){
		var container = getContainer(this);
		if(container.find("span.jt_g").length){//不为空
			container.find(".result_d").find('span.jt_g').each(function(){
				var attr = $(this).data('attr');
				var _child = $(this).text();
				//属性不能相同
				if(container.find(".yjtj[data-attr="+attr+"]").length){
					return true;
				}
				container.find(".add_del_y").prepend('<span class="yjtj" data-attr='+attr+' onmouseover="yjtjshow(this)" onmouseout="yjtjout(this)">'+_child+'<img src="/themes/merchants/img/close_11.png" onclick="yjtjclick(this)" class="close_gg" style="display:none;"></span>');
			});
			generateSpecifTable();
		}
		container.find(".yjtj").show();
		container.find(".common_a_tow").hide();
	});
	//点击取消属性
	$(".cancel_one").on("click",function(){
		var container = getContainer(this);
		//隐藏属性选择
		container.find(".common_a_tow").hide();
		//移除文本框数据
		container.find("span.jt_g").remove();
		showAttrList(container);
	});
	
}
//根据选择的属性判断属性选择区域是否显示隐藏
function showAttrList(container){
	//获取已选择的数据
	var filterM = {};
	container.find("span.yjtj").each(function(){
		filterM[$(this).data('attr')] = 'Y';
	});
	//在选择区的隐藏，没在的显示
	var licount = 0;
	var hidecount = 0;
	var attrListDOM = container.find(".common_a_li");
	attrListDOM.find("li").each(function(){
		licount ++;
		if(filterM[$(this).data('attr')]){
			$(this).hide();
			hidecount++;
		}else{
	    	$(this).show();
		}
    });
	if(licount == hidecount){
		attrListDOM.hide();
	}else{
		attrListDOM.show()
	}
}
//当前选中的属性mouseover
function yjtjshow(obj){
	$(obj).find("img").show();
}
//当前选中的属性mouseout
function yjtjout(obj){
	$(obj).find("img").hide();
}
//删除一个属性
function yjtjclick(obj){
	$(obj).closest("span").first().remove();
	generateSpecifTable();
}
function highlightSpecifi(){
	$(".check_list_info li:first").addClass("li_on1");
	 
	$('.check_list_info li').mouseover(function(){
		  $(this).addClass("li_on1");
	});
	$('.check_list_info li').mouseout(function(){
		  $(this).removeClass("li_on1");
	});
	$(".common_a_li li:first").addClass("li_on1");
	 
	$('.common_a_li li').mouseover(function(){
		  $(this).addClass("li_on1");
	});
	$('.common_a_li li').mouseout(function(){
		  $(this).removeClass("li_on1");
	});
}
//选择框里面的属性 点击删除
function jt_g_click(obj){
	var container = getContainer(obj);
	var obj = $(obj);
	obj.remove();
	var _id = obj.data("attr");
	
	container.find(".add_del_y span").each(function(){
		if(_id == $(this).data("attr")){
			$(this).remove();
			return true;
	    }
	});
	
	container.find(".common_a_li li").each(function(){
	    if(_id == $(this).data("attr")){
	    	$(this).show();
	    	return true;
	    }
	});
}
//规格存在则显示属性添加的按钮，否则隐藏
function isSpecifSelected(container){
	var check_val = container.find(".stand_check").text();
	if(check_val == null || check_val.length == 0) { 
		container.find(".add_common_a").hide();
	}else{
		container.find(".add_common_a").show();
	}
}

function getContainer(obj){
	var container = $(obj).closest(".standFlag").first();
	return container; 
}
//根据选择的属性规格，生成table
function generateSpecifTable(){
	var specifs = $(".standFlag").find(".stand_check");
	var arr = [];
	specifs.each(function(){
		var obj = $(this);
		var attrs = getContainer(obj).find("span.yjtj");
		if(!attrs || !attrs.length){
			return true;
		}
		var attr_arr = [];
		attrs.each(function(){
			attr_arr.push({attr : $(this).data('attr'), text : $(this).text()});	
		});
		arr.push({cat_id : obj.data('cat'), cat_name : obj.text(), attrs : attr_arr});
	});
	var TR_HD = "<tr>";
	var attr_as = [];
	for(var i = 0,len=arr.length; i < len; i++){
		var spe = arr[i];
		TR_HD += "<td>"+spe.cat_name+"</td>";
		attr_as.push(spe.attrs);
	}
	if(!arr.length || !attr_as.length){
		$(".goods_stocks").html("");
		$(".goods_stockDIV").hide();
		return;
	}
	var result =  [];
	dke_Array(0,null, attr_as, result);
	TR_HD += "<td>市场价</td>";
	TR_HD += "<td>售价</td>";
	TR_HD += "<td>供货价</td>";
	TR_HD += "<td>成本价</td>";
	TR_HD += "<td>库存</td></tr>";
	result.forEach(function(item){
		if(item.length){
			TR_HD += "<tr class='attr_data'>";
			var attrct = 1;
			item.forEach(function(attrObj){
				TR_HD += "<td class='attrcls' data-attr='"+attrObj.attr+"'>"+attrObj.text+"</td>";
			});
			TR_HD += "<td><input type='text' class='attr_market_price' data-type='money' value='' required ></td>";
			TR_HD += "<td><input type='text' class='attr_shop_price' data-type='money' value='' required ></td>";
			TR_HD += "<td><input type='text' class='attr_income_price' data-type='money' value='' required ></td>";
			TR_HD += "<td><input type='text' class='attr_cost_price' data-type='money' value='' required ></td>";
			TR_HD += "<td><input type='number' class='attr_goods_number' value='' required ></td></tr>";
		}
	});
	$(".goods_stocks").html($(TR_HD));
	$(".goods_stockDIV").show();
}

function buildGoodsSpecif(data){
	var attrsDOM = $(".goods_stocks").find("tr.attr_data");
	var attrdata = [];
	attrsDOM.each(function(){
		var obj = $(this);
		var attr = {};
		var at_count = 1;
		obj.find(".attrcls").each(function(){
			attr['attr_id'+at_count] = $(this).data("attr");
			attr['attr_value'+at_count] = $(this).text();
			at_count++;
		});
		attr.market_price = obj.find(".attr_market_price").val();
		attr.shop_price = obj.find(".attr_shop_price").val();
		attr.income_price = obj.find(".attr_income_price").val();
		attr.cost_price = obj.find(".attr_cost_price").val();
		attr.goods_number = obj.find(".attr_goods_number").val();
		attrdata.push(attr);
	});
	data.attribute_list = attrdata;
}

</script>
